#!/usr/bin/env python3
"""
Test du nouveau syst√®me d'√©dition du nom d'entreprise avec verrouillage
Test sp√©cifique pour la fonctionnalit√© crayon/coche verte de sauvegarde

Bas√© sur la demande de test en fran√ßais:
- Connecter avec lperpere@yahoo.fr / L@Reunion974!
- Tester la sauvegarde avec PUT /api/business-profile
- V√©rifier la persistance avec GET /api/business-profile
- S'assurer que les donn√©es ne reviennent pas √† "Restaurant Test Persistance"
"""

import requests
import json
import sys
from datetime import datetime

class BusinessNameEditTester:
    def __init__(self):
        # Use production backend URL from frontend/.env
        self.base_url = "https://claire-marcus-app-1.preview.emergentagent.com"
        self.api_url = f"{self.base_url}/api"
        self.access_token = None
        self.tests_run = 0
        self.tests_passed = 0
        
        # Test credentials from review request
        self.test_email = "lperpere@yahoo.fr"
        self.test_password = "L@Reunion974!"
        
        # Test data from review request
        self.new_business_name = "Mon Super Restaurant Modifi√© 2025"

    def log_test(self, name, success, details=""):
        """Log test results"""
        self.tests_run += 1
        if success:
            self.tests_passed += 1
            print(f"‚úÖ {name}")
            if details:
                print(f"   {details}")
        else:
            print(f"‚ùå {name}")
            if details:
                print(f"   {details}")

    def make_request(self, method, endpoint, data=None, expected_status=200):
        """Make API request with proper headers"""
        url = f"{self.api_url}/{endpoint}"
        headers = {
            'Content-Type': 'application/json'
        }
        
        if self.access_token:
            headers['Authorization'] = f'Bearer {self.access_token}'
        
        try:
            if method == 'GET':
                response = requests.get(url, headers=headers)
            elif method == 'POST':
                response = requests.post(url, json=data, headers=headers)
            elif method == 'PUT':
                response = requests.put(url, json=data, headers=headers)
            elif method == 'DELETE':
                response = requests.delete(url, headers=headers)
            
            success = response.status_code == expected_status
            
            try:
                response_data = response.json()
            except:
                response_data = {"text": response.text}
            
            return success, response.status_code, response_data
            
        except Exception as e:
            return False, 0, {"error": str(e)}

    def test_authentication(self):
        """Test 1: Authentification avec lperpere@yahoo.fr / L@Reunion974!"""
        print("\nüîê TEST 1: Authentification utilisateur")
        
        login_data = {
            "email": self.test_email,
            "password": self.test_password
        }
        
        success, status, response = self.make_request('POST', 'auth/login', login_data, 200)
        
        if success and 'access_token' in response:
            self.access_token = response['access_token']
            user_id = response.get('user_id', 'N/A')
            self.log_test(
                "Authentification r√©ussie", 
                True, 
                f"User ID: {user_id}, Token: {self.access_token[:20]}..."
            )
            return True
        else:
            self.log_test(
                "Authentification √©chou√©e", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def test_get_current_business_profile(self):
        """Test 2: R√©cup√©ration du profil d'entreprise actuel"""
        print("\nüìã TEST 2: R√©cup√©ration du profil d'entreprise actuel")
        
        success, status, response = self.make_request('GET', 'business-profile', expected_status=200)
        
        if success:
            business_name = response.get('business_name', 'N/A')
            business_type = response.get('business_type', 'N/A')
            email = response.get('email', 'N/A')
            website_url = response.get('website_url', 'N/A')
            
            self.log_test(
                "Profil d'entreprise r√©cup√©r√©", 
                True, 
                f"Nom: '{business_name}', Type: '{business_type}', Email: '{email}', Site: '{website_url}'"
            )
            
            # Store current profile for comparison
            self.current_profile = response
            return True
        else:
            self.log_test(
                "√âchec r√©cup√©ration profil", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def test_update_business_name(self):
        """Test 3: Mise √† jour du nom d'entreprise via PUT /api/business-profile"""
        print(f"\n‚úèÔ∏è TEST 3: Mise √† jour du nom d'entreprise vers '{self.new_business_name}'")
        
        if not hasattr(self, 'current_profile'):
            self.log_test("Pas de profil actuel disponible", False)
            return False
        
        # Prepare updated profile with new business name
        updated_profile = self.current_profile.copy()
        updated_profile['business_name'] = self.new_business_name
        
        # Remove fields that shouldn't be in PUT request
        for field in ['_id', 'profile_id', 'created_at', 'updated_at']:
            updated_profile.pop(field, None)
        
        success, status, response = self.make_request('PUT', 'business-profile', updated_profile, 200)
        
        if success:
            returned_name = response.get('profile', {}).get('business_name', 'N/A')
            self.log_test(
                "Mise √† jour du nom d'entreprise r√©ussie", 
                True, 
                f"Nom retourn√© dans la r√©ponse: '{returned_name}'"
            )
            return True
        else:
            self.log_test(
                "√âchec mise √† jour nom d'entreprise", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def test_verify_persistence_immediate(self):
        """Test 4: V√©rification imm√©diate de la persistance avec GET"""
        print(f"\nüîç TEST 4: V√©rification imm√©diate de la persistance")
        
        success, status, response = self.make_request('GET', 'business-profile', expected_status=200)
        
        if success:
            business_name = response.get('business_name', 'N/A')
            
            if business_name == self.new_business_name:
                self.log_test(
                    "Persistance imm√©diate confirm√©e", 
                    True, 
                    f"Nom r√©cup√©r√©: '{business_name}' (correspond au nom sauvegard√©)"
                )
                return True
            else:
                self.log_test(
                    "√âchec persistance imm√©diate", 
                    False, 
                    f"Nom attendu: '{self.new_business_name}', Nom r√©cup√©r√©: '{business_name}'"
                )
                return False
        else:
            self.log_test(
                "√âchec r√©cup√©ration pour v√©rification", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def test_verify_no_revert_to_test_data(self):
        """Test 5: V√©rification que les donn√©es ne reviennent pas √† 'Restaurant Test Persistance'"""
        print(f"\nüö´ TEST 5: V√©rification anti-r√©gression - pas de retour √† 'Restaurant Test Persistance'")
        
        success, status, response = self.make_request('GET', 'business-profile', expected_status=200)
        
        if success:
            business_name = response.get('business_name', 'N/A')
            
            if business_name == "Restaurant Test Persistance":
                self.log_test(
                    "R√âGRESSION D√âTECT√âE", 
                    False, 
                    f"Le nom est revenu √† 'Restaurant Test Persistance' au lieu de '{self.new_business_name}'"
                )
                return False
            elif business_name == self.new_business_name:
                self.log_test(
                    "Pas de r√©gression - donn√©es correctes", 
                    True, 
                    f"Nom maintenu: '{business_name}'"
                )
                return True
            else:
                self.log_test(
                    "Nom inattendu mais pas de r√©gression", 
                    True, 
                    f"Nom actuel: '{business_name}' (diff√©rent de 'Restaurant Test Persistance')"
                )
                return True
        else:
            self.log_test(
                "√âchec v√©rification anti-r√©gression", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def test_multiple_get_requests(self):
        """Test 6: Tests multiples GET pour simuler les rafra√Æchissements de l'interface"""
        print(f"\nüîÑ TEST 6: Tests multiples GET (simulation rafra√Æchissements interface)")
        
        consistent_results = True
        results = []
        
        for i in range(5):
            success, status, response = self.make_request('GET', 'business-profile', expected_status=200)
            
            if success:
                business_name = response.get('business_name', 'N/A')
                results.append(business_name)
                print(f"   GET #{i+1}: '{business_name}'")
            else:
                results.append(f"ERROR_{status}")
                consistent_results = False
        
        # Check if all results are consistent
        if consistent_results and len(set(results)) == 1:
            final_name = results[0]
            if final_name == self.new_business_name:
                self.log_test(
                    "Consistance parfaite sur 5 requ√™tes", 
                    True, 
                    f"Nom stable: '{final_name}'"
                )
                return True
            else:
                self.log_test(
                    "Consistance mais nom incorrect", 
                    False, 
                    f"Nom stable: '{final_name}' (attendu: '{self.new_business_name}')"
                )
                return False
        else:
            self.log_test(
                "Inconsistance d√©tect√©e", 
                False, 
                f"R√©sultats variables: {set(results)}"
            )
            return False

    def test_business_profile_completeness(self):
        """Test 7: V√©rification de la compl√©tude du profil d'entreprise"""
        print(f"\nüìä TEST 7: V√©rification compl√©tude du profil d'entreprise")
        
        success, status, response = self.make_request('GET', 'business-profile', expected_status=200)
        
        if success:
            expected_fields = [
                'business_name', 'business_type', 'business_description',
                'target_audience', 'brand_tone', 'posting_frequency',
                'preferred_platforms', 'budget_range', 'email', 'website_url',
                'hashtags_primary', 'hashtags_secondary'
            ]
            
            missing_fields = []
            present_fields = []
            
            for field in expected_fields:
                if field in response:
                    present_fields.append(field)
                else:
                    missing_fields.append(field)
            
            if not missing_fields:
                self.log_test(
                    "Profil complet - tous les champs pr√©sents", 
                    True, 
                    f"{len(present_fields)}/12 champs pr√©sents"
                )
                return True
            else:
                self.log_test(
                    "Profil incomplet", 
                    False, 
                    f"Champs manquants: {missing_fields}"
                )
                return False
        else:
            self.log_test(
                "√âchec v√©rification compl√©tude", 
                False, 
                f"Status: {status}, Response: {response}"
            )
            return False

    def run_all_tests(self):
        """Ex√©cuter tous les tests du syst√®me d'√©dition du nom d'entreprise"""
        print("üöÄ D√âBUT DES TESTS - SYST√àME D'√âDITION DU NOM D'ENTREPRISE")
        print("=" * 80)
        print(f"Backend URL: {self.base_url}")
        print(f"Utilisateur de test: {self.test_email}")
        print(f"Nouveau nom d'entreprise: {self.new_business_name}")
        print("=" * 80)
        
        # S√©quence de tests
        test_sequence = [
            ("Authentification", self.test_authentication),
            ("R√©cup√©ration profil actuel", self.test_get_current_business_profile),
            ("Mise √† jour nom d'entreprise", self.test_update_business_name),
            ("V√©rification persistance imm√©diate", self.test_verify_persistence_immediate),
            ("V√©rification anti-r√©gression", self.test_verify_no_revert_to_test_data),
            ("Tests multiples GET", self.test_multiple_get_requests),
            ("V√©rification compl√©tude profil", self.test_business_profile_completeness),
        ]
        
        # Ex√©cuter les tests
        for test_name, test_func in test_sequence:
            try:
                test_func()
            except Exception as e:
                self.log_test(f"ERREUR dans {test_name}", False, f"Exception: {str(e)}")
        
        # R√©sum√© final
        print("\n" + "=" * 80)
        print("üìä R√âSUM√â DES TESTS")
        print("=" * 80)
        print(f"Tests ex√©cut√©s: {self.tests_run}")
        print(f"Tests r√©ussis: {self.tests_passed}")
        print(f"Tests √©chou√©s: {self.tests_run - self.tests_passed}")
        print(f"Taux de r√©ussite: {(self.tests_passed/self.tests_run*100):.1f}%" if self.tests_run > 0 else "0%")
        
        if self.tests_passed == self.tests_run:
            print("\nüéâ TOUS LES TESTS SONT PASS√âS!")
            print("‚úÖ Le syst√®me d'√©dition du nom d'entreprise fonctionne correctement")
            print("‚úÖ La persistance des donn√©es est assur√©e")
            print("‚úÖ Pas de r√©gression vers 'Restaurant Test Persistance'")
        else:
            print(f"\n‚ö†Ô∏è {self.tests_run - self.tests_passed} TEST(S) ONT √âCHOU√â")
            print("‚ùå Le syst√®me d'√©dition n√©cessite des corrections")
        
        print("=" * 80)
        
        return self.tests_passed == self.tests_run

if __name__ == "__main__":
    tester = BusinessNameEditTester()
    success = tester.run_all_tests()
    sys.exit(0 if success else 1)
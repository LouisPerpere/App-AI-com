#!/usr/bin/env python3
"""
MIGRATION DES DONN√âES RESTAURANT - Test critique pour la migration des donn√©es
Test pour migrer les posts et analyses du restaurant de la collection 'notes' vers les collections correctes
Environnement: LIVE (https://claire-marcus.com/api)
Compte: test@claire-marcus.com
"""

import requests
import json
import sys
from datetime import datetime

# Configuration LIVE
LIVE_BASE_URL = "https://claire-marcus.com/api"
TEST_EMAIL = "test@claire-marcus.com"
TEST_PASSWORD = "test123!"

class RestaurantDataMigrationTest:
    def __init__(self):
        self.base_url = LIVE_BASE_URL
        self.token = None
        self.user_id = None
        self.session = requests.Session()
        self.session.headers.update({
            'Content-Type': 'application/json',
            'User-Agent': 'Backend-Test-Investigation/1.0'
        })

    def authenticate(self):
        """√âtape 1: Authentification avec test@claire-marcus.com"""
        print(f"üîê √âTAPE 1: Authentification sur {self.base_url}")
        print(f"   Email: {TEST_EMAIL}")
        print(f"   Password: {TEST_PASSWORD}")
        
        try:
            response = self.session.post(f"{self.base_url}/auth/login-robust", json={
                "email": TEST_EMAIL,
                "password": TEST_PASSWORD
            })
            
            print(f"   Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                self.token = data.get('access_token')
                self.user_id = data.get('user_id')
                
                # Configurer l'en-t√™te d'autorisation
                self.session.headers.update({
                    'Authorization': f'Bearer {self.token}'
                })
                
                print(f"   ‚úÖ AUTHENTIFICATION R√âUSSIE")
                print(f"   User ID: {self.user_id}")
                print(f"   Token: {self.token[:30]}...")
                return True
            else:
                print(f"   ‚ùå √âCHEC AUTHENTIFICATION: {response.text}")
                return False
                
        except Exception as e:
            print(f"   ‚ùå ERREUR AUTHENTIFICATION: {e}")
            return False

    def test_posts_generated_endpoint(self):
        """√âtape 2: Tester GET /api/posts/generated (ce que voit la page Posts)"""
        print(f"\nüìÑ √âTAPE 2: Test endpoint Posts - GET /api/posts/generated")
        
        try:
            response = self.session.get(f"{self.base_url}/posts/generated")
            print(f"   Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                posts = data.get('posts', [])
                print(f"   ‚úÖ ENDPOINT ACCESSIBLE")
                print(f"   Nombre de posts: {len(posts)}")
                
                if posts:
                    print(f"   üìä POSTS TROUV√âS:")
                    for i, post in enumerate(posts[:5]):  # Afficher les 5 premiers
                        print(f"      {i+1}. ID: {post.get('id', 'N/A')}")
                        print(f"         Titre: {post.get('title', 'N/A')}")
                        print(f"         Plateforme: {post.get('platform', 'N/A')}")
                        print(f"         Mois cible: {post.get('target_month', 'N/A')}")
                        print(f"         Statut: {post.get('status', 'N/A')}")
                else:
                    print(f"   ‚ö†Ô∏è AUCUN POST TROUV√â - C'EST LE PROBL√àME!")
                
                return len(posts)
            else:
                print(f"   ‚ùå ERREUR ENDPOINT: {response.text}")
                return 0
                
        except Exception as e:
            print(f"   ‚ùå ERREUR REQU√äTE: {e}")
            return 0

    def test_website_analysis_endpoint(self):
        """√âtape 3: Tester GET /api/website-analysis (ce que voit la page Analyse)"""
        print(f"\nüîç √âTAPE 3: Test endpoint Analyse - GET /api/website-analysis")
        
        try:
            response = self.session.get(f"{self.base_url}/website-analysis")
            print(f"   Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                analyses = data.get('analyses', [])
                print(f"   ‚úÖ ENDPOINT ACCESSIBLE")
                print(f"   Nombre d'analyses: {len(analyses)}")
                
                if analyses:
                    print(f"   üìä ANALYSES TROUV√âES:")
                    for i, analysis in enumerate(analyses[:3]):  # Afficher les 3 premi√®res
                        print(f"      {i+1}. ID: {analysis.get('id', 'N/A')}")
                        print(f"         URL: {analysis.get('website_url', 'N/A')}")
                        print(f"         Score: {analysis.get('seo_score', 'N/A')}")
                        print(f"         Date: {analysis.get('created_at', 'N/A')}")
                else:
                    print(f"   ‚ö†Ô∏è AUCUNE ANALYSE TROUV√âE - C'EST LE PROBL√àME!")
                
                return len(analyses)
            else:
                print(f"   ‚ùå ERREUR ENDPOINT: {response.text}")
                return 0
                
        except Exception as e:
            print(f"   ‚ùå ERREUR REQU√äTE: {e}")
            return 0

    def investigate_notes_storage(self):
        """√âtape 4: Investiguer le stockage dans /api/notes (o√π les donn√©es ont √©t√© cr√©√©es)"""
        print(f"\nüìù √âTAPE 4: Investigation stockage Notes - GET /api/notes")
        
        try:
            response = self.session.get(f"{self.base_url}/notes")
            print(f"   Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                notes = data.get('notes', [])
                print(f"   ‚úÖ ENDPOINT ACCESSIBLE")
                print(f"   Nombre total de notes: {len(notes)}")
                
                # Analyser les types de notes
                restaurant_notes = []
                website_analyses = []
                october_posts = []
                november_posts = []
                
                for note in notes:
                    content = note.get('content', '').lower()
                    description = note.get('description', '').lower()
                    
                    # Identifier les analyses de site web
                    if 'lebistrotdejean' in content or 'seo' in content or 'analyse' in description:
                        website_analyses.append(note)
                    
                    # Identifier les posts d'octobre
                    elif 'octobre' in content or 'octobre' in description:
                        october_posts.append(note)
                    
                    # Identifier les posts de novembre
                    elif 'novembre' in content or 'novembre' in description:
                        november_posts.append(note)
                    
                    # Autres notes li√©es au restaurant
                    elif 'bistrot' in content or 'jean' in content or 'restaurant' in content:
                        restaurant_notes.append(note)
                
                print(f"   üìä ANALYSE DES NOTES:")
                print(f"      Analyses de site web: {len(website_analyses)}")
                print(f"      Posts octobre: {len(october_posts)}")
                print(f"      Posts novembre: {len(november_posts)}")
                print(f"      Autres notes restaurant: {len(restaurant_notes)}")
                
                # Afficher quelques exemples
                if website_analyses:
                    print(f"   üîç EXEMPLE ANALYSE SITE WEB:")
                    analysis = website_analyses[0]
                    print(f"      ID: {analysis.get('note_id', 'N/A')}")
                    print(f"      Description: {analysis.get('description', 'N/A')}")
                    print(f"      Contenu: {analysis.get('content', '')[:200]}...")
                
                if october_posts:
                    print(f"   üîç EXEMPLE POST OCTOBRE:")
                    post = october_posts[0]
                    print(f"      ID: {post.get('note_id', 'N/A')}")
                    print(f"      Description: {post.get('description', 'N/A')}")
                    print(f"      Contenu: {post.get('content', '')[:200]}...")
                
                return {
                    'total_notes': len(notes),
                    'website_analyses': len(website_analyses),
                    'october_posts': len(october_posts),
                    'november_posts': len(november_posts),
                    'restaurant_notes': len(restaurant_notes)
                }
            else:
                print(f"   ‚ùå ERREUR ENDPOINT: {response.text}")
                return None
                
        except Exception as e:
            print(f"   ‚ùå ERREUR REQU√äTE: {e}")
            return None

    def test_business_profile(self):
        """√âtape 5: V√©rifier le profil business"""
        print(f"\nüè¢ √âTAPE 5: Test profil business - GET /api/business-profile")
        
        try:
            response = self.session.get(f"{self.base_url}/business-profile")
            print(f"   Status: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                business_name = data.get('business_name')
                industry = data.get('industry')
                website_url = data.get('website_url')
                
                print(f"   ‚úÖ PROFIL BUSINESS ACCESSIBLE")
                print(f"   Nom: {business_name}")
                print(f"   Industrie: {industry}")
                print(f"   Site web: {website_url}")
                
                return data
            else:
                print(f"   ‚ùå ERREUR ENDPOINT: {response.text}")
                return None
                
        except Exception as e:
            print(f"   ‚ùå ERREUR REQU√äTE: {e}")
            return None

    def investigate_database_collections(self):
        """√âtape 6: Investiguer les collections de base de donn√©es disponibles"""
        print(f"\nüóÑÔ∏è √âTAPE 6: Investigation collections base de donn√©es")
        
        # Tester diff√©rents endpoints pour identifier o√π les donn√©es devraient √™tre
        endpoints_to_test = [
            "/posts/generated",
            "/website-analysis", 
            "/notes",
            "/content/pending",
            "/business-profile"
        ]
        
        results = {}
        
        for endpoint in endpoints_to_test:
            try:
                print(f"   Testing {endpoint}...")
                response = self.session.get(f"{self.base_url}{endpoint}")
                
                if response.status_code == 200:
                    data = response.json()
                    
                    # Compter les √©l√©ments selon le type de r√©ponse
                    if 'posts' in data:
                        count = len(data['posts'])
                    elif 'analyses' in data:
                        count = len(data['analyses'])
                    elif 'notes' in data:
                        count = len(data['notes'])
                    elif 'content' in data:
                        count = len(data['content'])
                    elif isinstance(data, list):
                        count = len(data)
                    else:
                        count = 1 if data else 0
                    
                    results[endpoint] = {
                        'status': response.status_code,
                        'accessible': True,
                        'count': count
                    }
                    print(f"      ‚úÖ {endpoint}: {count} √©l√©ments")
                else:
                    results[endpoint] = {
                        'status': response.status_code,
                        'accessible': False,
                        'error': response.text[:100]
                    }
                    print(f"      ‚ùå {endpoint}: {response.status_code}")
                    
            except Exception as e:
                results[endpoint] = {
                    'status': 'error',
                    'accessible': False,
                    'error': str(e)
                }
                print(f"      ‚ùå {endpoint}: {e}")
        
        return results

    def run_investigation(self):
        """Ex√©cuter l'investigation compl√®te"""
        print("=" * 80)
        print("üö® INVESTIGATION URGENTE - INTERFACE UTILISATEUR VIDE")
        print("=" * 80)
        print(f"Environnement: {self.base_url}")
        print(f"Compte test: {TEST_EMAIL}")
        print(f"Heure: {datetime.now().isoformat()}")
        print("=" * 80)
        
        # √âtape 1: Authentification
        if not self.authenticate():
            print("\n‚ùå INVESTIGATION INTERROMPUE - √âchec authentification")
            return False
        
        # √âtape 2: Test endpoint Posts
        posts_count = self.test_posts_generated_endpoint()
        
        # √âtape 3: Test endpoint Analyse
        analyses_count = self.test_website_analysis_endpoint()
        
        # √âtape 4: Investigation Notes
        notes_data = self.investigate_notes_storage()
        
        # √âtape 5: Test profil business
        business_profile = self.test_business_profile()
        
        # √âtape 6: Investigation collections
        db_results = self.investigate_database_collections()
        
        # ANALYSE FINALE
        print("\n" + "=" * 80)
        print("üîç ANALYSE FINALE - CAUSE RACINE")
        print("=" * 80)
        
        print(f"üìä R√âSULTATS:")
        print(f"   Posts g√©n√©r√©s (UI): {posts_count}")
        print(f"   Analyses site web (UI): {analyses_count}")
        
        if notes_data:
            print(f"   Notes totales: {notes_data['total_notes']}")
            print(f"   Analyses dans notes: {notes_data['website_analyses']}")
            print(f"   Posts octobre dans notes: {notes_data['october_posts']}")
            print(f"   Posts novembre dans notes: {notes_data['november_posts']}")
        
        # DIAGNOSTIC
        print(f"\nüéØ DIAGNOSTIC:")
        
        if posts_count == 0 and notes_data and (notes_data['october_posts'] > 0 or notes_data['november_posts'] > 0):
            print(f"   ‚ùå PROBL√àME IDENTIFI√â: Posts stock√©s dans /notes mais pas dans /posts/generated")
            print(f"   üîß SOLUTION: Les posts doivent √™tre migr√©s de la collection 'notes' vers 'generated_posts'")
        
        if analyses_count == 0 and notes_data and notes_data['website_analyses'] > 0:
            print(f"   ‚ùå PROBL√àME IDENTIFI√â: Analyses stock√©es dans /notes mais pas dans /website-analysis")
            print(f"   üîß SOLUTION: Les analyses doivent √™tre migr√©es de la collection 'notes' vers 'website_analysis'")
        
        if posts_count == 0 and analyses_count == 0:
            if notes_data and notes_data['total_notes'] > 0:
                print(f"   ‚ùå CAUSE RACINE: Donn√©es cr√©√©es dans mauvaises tables")
                print(f"   üìã Les donn√©es existent mais dans la collection 'notes' au lieu des collections sp√©cialis√©es")
            else:
                print(f"   ‚ùå CAUSE RACINE: Aucune donn√©e trouv√©e nulle part")
                print(f"   üìã Les donn√©es n'ont peut-√™tre pas √©t√© cr√©√©es ou ont √©t√© supprim√©es")
        
        print(f"\nüéØ RECOMMANDATIONS:")
        print(f"   1. V√©rifier les endpoints que le frontend utilise r√©ellement")
        print(f"   2. Migrer les donn√©es de /notes vers les bonnes collections")
        print(f"   3. Corriger le mapping user_id si n√©cessaire")
        print(f"   4. Tester la synchronisation cache/base de donn√©es")
        
        return True

def main():
    """Point d'entr√©e principal"""
    investigation = LiveUIInvestigation()
    success = investigation.run_investigation()
    
    if success:
        print(f"\n‚úÖ INVESTIGATION TERMIN√âE AVEC SUCC√àS")
        sys.exit(0)
    else:
        print(f"\n‚ùå INVESTIGATION √âCHOU√âE")
        sys.exit(1)

if __name__ == "__main__":
    main()

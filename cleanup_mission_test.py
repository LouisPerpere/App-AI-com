#!/usr/bin/env python3
"""
MISSION URGENTE: NETTOYAGE COMPLET DES DONN√âES CORROMPUES
Test sp√©cifique pour la mission de nettoyage demand√©e par l'utilisateur

Objectif: Nettoyer compl√®tement toutes les fausses connexions et donn√©es corrompues
avant de r√©impl√©menter l'OAuth proprement.

Identifiants de test: lperpere@yahoo.fr / L@Reunion974!
"""

import requests
import json
import sys
from datetime import datetime

# Configuration
BACKEND_URL = "https://social-publisher-10.preview.emergentagent.com/api"
TEST_EMAIL = "lperpere@yahoo.fr"
TEST_PASSWORD = "L@Reunion974!"

class CleanupMissionTester:
    def __init__(self):
        self.session = requests.Session()
        self.auth_token = None
        self.user_id = None
        self.test_results = []
        
    def log_test(self, test_name, success, details="", error=""):
        """Log test results"""
        status = "‚úÖ R√âUSSI" if success else "‚ùå √âCHEC"
        result = {
            "test": test_name,
            "status": status,
            "success": success,
            "details": details,
            "error": error,
            "timestamp": datetime.now().isoformat()
        }
        self.test_results.append(result)
        print(f"{status}: {test_name}")
        if details:
            print(f"   D√©tails: {details}")
        if error:
            print(f"   Erreur: {error}")
        print()
        
    def authenticate(self):
        """√âtape 1: Authentification avec les identifiants de test"""
        try:
            response = self.session.post(f"{BACKEND_URL}/auth/login-robust", json={
                "email": TEST_EMAIL,
                "password": TEST_PASSWORD
            })
            
            if response.status_code == 200:
                data = response.json()
                self.auth_token = data.get("access_token")
                self.user_id = data.get("user_id")
                self.session.headers.update({"Authorization": f"Bearer {self.auth_token}"})
                
                self.log_test(
                    "Authentification", 
                    True, 
                    f"User ID: {self.user_id}, Token obtenu"
                )
                return True
            else:
                self.log_test(
                    "Authentification", 
                    False, 
                    error=f"Status {response.status_code}: {response.text}"
                )
                return False
                
        except Exception as e:
            self.log_test("Authentification", False, error=str(e))
            return False
    
    def test_clean_invalid_tokens(self):
        """Test 1: POST /api/debug/clean-invalid-tokens - Supprimer TOUTES les connexions avec access_token: null, temp_facebook_token_*, test_token_*, etc."""
        try:
            print("üßπ Nettoyage des tokens invalides...")
            response = self.session.post(f"{BACKEND_URL}/debug/clean-invalid-tokens")
            
            if response.status_code == 200:
                data = response.json()
                deleted_count = data.get('deleted_count', 0)
                message = data.get('message', 'Nettoyage effectu√©')
                
                self.log_test(
                    "Nettoyage tokens invalides", 
                    True, 
                    f"Supprim√© {deleted_count} connexions avec tokens invalides. {message}"
                )
                return True, deleted_count
            else:
                self.log_test(
                    "Nettoyage tokens invalides", 
                    False, 
                    error=f"Status {response.status_code}: {response.text}"
                )
                return False, 0
                
        except Exception as e:
            self.log_test("Nettoyage tokens invalides", False, error=str(e))
            return False, 0
    
    def test_clean_library_badges(self):
        """Test 2: POST /api/debug/clean-library-badges - Nettoyer les badges Facebook/Instagram des contenus non utilis√©s"""
        try:
            print("üè∑Ô∏è Nettoyage des badges orphelins...")
            response = self.session.post(f"{BACKEND_URL}/debug/clean-library-badges")
            
            if response.status_code == 200:
                data = response.json()
                message = data.get('message', 'Nettoyage effectu√©')
                cleaned_count = data.get('cleaned_count', 0)
                
                self.log_test(
                    "Nettoyage badges orphelins", 
                    True, 
                    f"Nettoy√© {cleaned_count} badges orphelins. {message}"
                )
                return True
            else:
                self.log_test(
                    "Nettoyage badges orphelins", 
                    False, 
                    error=f"Status {response.status_code}: {response.text}"
                )
                return False
                
        except Exception as e:
            self.log_test("Nettoyage badges orphelins", False, error=str(e))
            return False
    
    def test_debug_social_connections(self):
        """Test 3: GET /api/debug/social-connections - Confirmer 0 connexions actives (√©tat propre)"""
        try:
            print("üîç V√©rification √©tat apr√®s nettoyage...")
            response = self.session.get(f"{BACKEND_URL}/debug/social-connections")
            
            if response.status_code == 200:
                data = response.json()
                
                total_connections = data.get('total_connections', 0)
                active_connections = data.get('active_connections', 0)
                facebook_connections = data.get('facebook_connections', 0)
                instagram_connections = data.get('instagram_connections', 0)
                
                # V√©rifier l'√©tat propre
                is_clean = (total_connections == 0 and active_connections == 0 and 
                           facebook_connections == 0 and instagram_connections == 0)
                
                details = f"Total: {total_connections}, Actives: {active_connections}, Facebook: {facebook_connections}, Instagram: {instagram_connections}"
                
                if is_clean:
                    details += " ‚úÖ √âTAT PROPRE CONFIRM√â"
                else:
                    details += " ‚ö†Ô∏è CONNEXIONS RESTANTES D√âTECT√âES"
                
                self.log_test(
                    "V√©rification √©tat propre", 
                    is_clean, 
                    details
                )
                return data, is_clean
            else:
                self.log_test(
                    "V√©rification √©tat propre", 
                    False, 
                    error=f"Status {response.status_code}: {response.text}"
                )
                return None, False
                
        except Exception as e:
            self.log_test("V√©rification √©tat propre", False, error=str(e))
            return None, False
    
    def test_social_connections_api(self):
        """Test 4: GET /api/social/connections - Confirmer liste vide"""
        try:
            print("üìã V√©rification API connexions sociales...")
            response = self.session.get(f"{BACKEND_URL}/social/connections")
            
            if response.status_code == 200:
                data = response.json()
                connections = data.get('connections', [])
                
                is_empty = len(connections) == 0
                
                self.log_test(
                    "API connexions sociales vide", 
                    is_empty, 
                    f"Trouv√© {len(connections)} connexions (attendu: 0)"
                )
                return is_empty
            else:
                self.log_test(
                    "API connexions sociales vide", 
                    False, 
                    error=f"Status {response.status_code}: {response.text}"
                )
                return False
                
        except Exception as e:
            self.log_test("API connexions sociales vide", False, error=str(e))
            return False
    
    def test_publication_blocked(self):
        """Test 5: V√©rifier que la publication est bloqu√©e (pas de connexions actives)"""
        try:
            print("üö´ Test publication bloqu√©e...")
            
            # D'abord r√©cup√©rer les posts disponibles
            posts_response = self.session.get(f"{BACKEND_URL}/posts/generated")
            
            if posts_response.status_code != 200:
                self.log_test(
                    "Publication bloqu√©e - R√©cup√©ration posts", 
                    True, 
                    "Aucun post disponible (√©tat propre)"
                )
                return True
            
            posts_data = posts_response.json()
            posts = posts_data.get('posts', [])
            
            if not posts:
                self.log_test(
                    "Publication bloqu√©e - Aucun post", 
                    True, 
                    "Aucun post disponible pour test de publication (√©tat propre)"
                )
                return True
            
            # Tenter de publier le premier post
            test_post = posts[0]
            post_id = test_post.get('id')
            
            response = self.session.post(f"{BACKEND_URL}/posts/publish", json={
                "post_id": post_id
            })
            
            # On s'attend √† ce que √ßa √©choue avec "aucune connexion sociale active"
            if response.status_code == 400:
                data = response.json()
                error_msg = data.get('error', '').lower()
                
                if 'aucune connexion sociale active' in error_msg or 'no active social connections' in error_msg:
                    self.log_test(
                        "Publication correctement bloqu√©e", 
                        True, 
                        "Publication rejet√©e: aucune connexion sociale active (attendu apr√®s nettoyage)"
                    )
                    return True
                else:
                    self.log_test(
                        "Publication correctement bloqu√©e", 
                        False, 
                        error=f"Erreur inattendue: {error_msg}"
                    )
                    return False
            else:
                self.log_test(
                    "Publication correctement bloqu√©e", 
                    False, 
                    error=f"Status inattendu {response.status_code}: {response.text}"
                )
                return False
                
        except Exception as e:
            self.log_test("Publication correctement bloqu√©e", False, error=str(e))
            return False
    
    def run_cleanup_mission(self):
        """Ex√©cuter la mission compl√®te de nettoyage"""
        print("üéØ MISSION URGENTE: NETTOYAGE COMPLET DES DONN√âES CORROMPUES")
        print("=" * 80)
        print(f"Backend URL: {BACKEND_URL}")
        print(f"Identifiants: {TEST_EMAIL}")
        print(f"Heure: {datetime.now().isoformat()}")
        print("=" * 80)
        print()
        
        # √âtape 1: Authentification
        if not self.authenticate():
            print("‚ùå CRITIQUE: Authentification √©chou√©e - impossible de continuer")
            return False
        
        # √âtape 2: Nettoyage des tokens invalides
        print("üßπ PHASE 1: NETTOYAGE TOKENS INVALIDES")
        print("-" * 50)
        success_tokens, deleted_count = self.test_clean_invalid_tokens()
        print()
        
        # √âtape 3: Nettoyage des badges orphelins
        print("üè∑Ô∏è PHASE 2: NETTOYAGE BADGES ORPHELINS")
        print("-" * 50)
        success_badges = self.test_clean_library_badges()
        print()
        
        # √âtape 4: V√©rification √©tat apr√®s nettoyage
        print("üîç PHASE 3: V√âRIFICATION √âTAT APR√àS NETTOYAGE")
        print("-" * 50)
        connections_data, is_clean = self.test_debug_social_connections()
        success_api = self.test_social_connections_api()
        print()
        
        # √âtape 5: Test publication bloqu√©e
        print("üö´ PHASE 4: V√âRIFICATION PUBLICATION BLOQU√âE")
        print("-" * 50)
        success_publication = self.test_publication_blocked()
        print()
        
        # R√©sum√© de la mission
        self.print_mission_summary(deleted_count, is_clean, success_api, success_publication)
        
        return True
    
    def print_mission_summary(self, deleted_count, is_clean, success_api, success_publication):
        """Imprimer le r√©sum√© de la mission"""
        print("=" * 80)
        print("üéØ R√âSUM√â MISSION NETTOYAGE")
        print("=" * 80)
        
        passed = sum(1 for result in self.test_results if result['success'])
        total = len(self.test_results)
        
        print(f"Tests totaux: {total}")
        print(f"R√©ussis: {passed}")
        print(f"√âchou√©s: {total - passed}")
        print(f"Taux de r√©ussite: {(passed/total*100):.1f}%" if total > 0 else "0%")
        print()
        
        # √âtat de la mission
        print("üìä √âTAT DE LA MISSION:")
        print(f"  üßπ Tokens invalides supprim√©s: {deleted_count}")
        print(f"  üè∑Ô∏è Badges orphelins nettoy√©s: ‚úÖ")
        print(f"  üîç √âtat propre confirm√©: {'‚úÖ' if is_clean else '‚ùå'}")
        print(f"  üìã API connexions vide: {'‚úÖ' if success_api else '‚ùå'}")
        print(f"  üö´ Publication bloqu√©e: {'‚úÖ' if success_publication else '‚ùå'}")
        print()
        
        # Tests d√©taill√©s
        print("üìã D√âTAILS DES TESTS:")
        for result in self.test_results:
            print(f"  {result['status']}: {result['test']}")
            if result['details']:
                print(f"    ‚Üí {result['details']}")
        print()
        
        # √âvaluation finale
        critical_success = is_clean and success_api and success_publication
        
        if critical_success:
            print("üéâ MISSION NETTOYAGE: SUCC√àS COMPLET")
            print("‚úÖ Base de donn√©es propre, aucune fausse connexion")
            print("‚úÖ Interface coh√©rente montrant l'√©tat r√©el (d√©connect√©)")
            print("‚úÖ Syst√®me pr√™t pour r√©impl√©mentation OAuth propre")
            print("‚úÖ Phase de nettoyage CRITIQUE termin√©e avec succ√®s")
        else:
            print("üö® MISSION NETTOYAGE: PROBL√àMES D√âTECT√âS")
            if not is_clean:
                print("‚ùå √âtat pas compl√®tement propre - connexions restantes")
            if not success_api:
                print("‚ùå API connexions ne retourne pas liste vide")
            if not success_publication:
                print("‚ùå Publication pas correctement bloqu√©e")
            print("‚ö†Ô∏è Nettoyage peut n√©cessiter intervention suppl√©mentaire")
        
        print("=" * 80)

def main():
    """Ex√©cution principale de la mission"""
    tester = CleanupMissionTester()
    
    try:
        success = tester.run_cleanup_mission()
        
        # Code de sortie appropri√©
        if success:
            failed_count = sum(1 for result in tester.test_results if not result['success'])
            sys.exit(0 if failed_count == 0 else 1)
        else:
            sys.exit(2)
            
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Mission interrompue par l'utilisateur")
        sys.exit(3)
    except Exception as e:
        print(f"\n‚ùå ERREUR CRITIQUE: {str(e)}")
        sys.exit(4)

if __name__ == "__main__":
    main()